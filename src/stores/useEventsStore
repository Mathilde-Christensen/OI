import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { db } from '../firebase'
import {
  ref as r, onValue, push, set, remove, runTransaction
} from 'firebase/database'


export const useEventsStore = defineStore('events', () => {
  const events = ref([])          // [{ id, title, start, end, location, capacity, durationMin, ... }]
  const stats = ref({})           // { eventId: { booked: n } }
  const myBookings = ref({})      // { eventId: true }
  const ready = ref(false)
  const uid = ref(null)           // sættes af Mathildes login → bindUser()

  // Hent/lyt events + statustæller
  function init() {
    onValue(r(db, 'events'), snap => {
      const obj = snap.val() || {}
      events.value = Object.entries(obj)
        .map(([id, v]) => ({ id, ...v }))
        .sort((a,b) => new Date(a.start) - new Date(b.start))
      ready.value = true
    })
    onValue(r(db, 'eventStats'), snap => { stats.value = snap.val() || {} })
  }

  // Kald denne, når I kender brugeren (fra Mathildes auth)
  function bindUser(userId) {
    uid.value = userId
    if (!userId) { myBookings.value = {}; return }
    onValue(r(db, `bookings/${userId}`), s => { myBookings.value = s.val() || {} })
  }

  // Kombinér event + status → ledige pladser / fuld
  const enriched = computed(() =>
    events.value.map(ev => {
      const booked = stats.value?.[ev.id]?.booked || 0
      const capacity = Number(ev.capacity ?? 0)
      const free = Math.max(0, capacity - booked)
      return { ...ev, booked, free, full: capacity > 0 && booked >= capacity }
    })
  )

  // Tilmeld/frameld
  async function tilmeld(eventId) {
    if (!uid.value) throw new Error('Log ind for at tilmelde')
    // increment booked atomisk
    const res = await runTransaction(r(db, `eventStats/${eventId}/booked`), curr => Number(curr || 0) + 1)
    if (!res.committed) throw new Error('Kunne ikke tilmelde – prøv igen')
    await set(r(db, `bookings/${uid.value}/${eventId}`), true)
  }

  async function frameld(eventId) {
    if (!uid.value) throw new Error('Log ind for at framelde')
    await runTransaction(r(db, `eventStats/${eventId}/booked`), curr => Math.max(0, Number(curr || 0) - 1))
    await remove(r(db, `bookings/${uid.value}/${eventId}`))
  }

  return { ready, enriched, myBookings, init, bindUser, tilmeld, frameld }
})